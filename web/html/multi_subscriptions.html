{{ template "page/head_start" .}}
{{ template "page/head_end" .}}

{{ template "page/body_start" .}}
<a-layout id="app" v-cloak :class="themeSwitcher.currentTheme + ' multi-subscriptions-page'">
  <a-sidebar></a-sidebar>
  <a-layout id="content-layout">
    <a-layout-content>
      <a-spin :spinning="loadingStates.spinning" :delay="200" :tip="loadingTip">
        <a-row :gutter="[16,16]">
          <a-col :span="24">
            <a-page-header :title='{{ i18n "pages.multiSubscriptions.title"}}'>
              <template slot="extra">
                <a-button type="primary" icon="plus" @click="openAdd">{{ i18n "pages.multiSubscriptions.add"}}</a-button>
                <a-button icon="sync" @click="refresh">{{ i18n "pages.nodes.refresh"}}</a-button>
              </template>
            </a-page-header>
          </a-col>
          <a-col :span="24">
            <a-table :data-source="items" :row-key="'id'" :pagination="false">
              <a-table-column :title='{{ i18n "pages.multiSubscriptions.name"}}' data-index="name" key="name"/>
              <a-table-column :title='{{ i18n "pages.multiSubscriptions.subId"}}' data-index="subId" key="subId"/>
              <a-table-column :title='{{ i18n "pages.multiSubscriptions.nodes"}}' key="nodes" :customRender="(_, r)=> (r.nodeIds)"></a-table-column>
              <a-table-column :title='{{ i18n "pages.multiSubscriptions.remark"}}' data-index="remark" key="remark"/>
              <a-table-column :title='{{ i18n "pages.multiSubscriptions.enabled"}}' key="enable" :customRender="(_, r)=> enableTpl(r)"/>
              <a-table-column :title='{{ i18n "pages.nodes.actions"}}' key="action" :customRender="(_, r)=> actionTpl(r)"/>
            </a-table>
          </a-col>
        </a-row>

        <a-modal :visible="modals.edit.visible" :title='{{ i18n "pages.multiSubscriptions.title"}}' :footer="null" @cancel="modals.edit.visible=false">
          <a-form :label-col="{span:6}" :wrapper-col="{span:16}">
            <a-form-item :label='{{ i18n "pages.multiSubscriptions.name"}}' :validate-status="v.name.status" :help="v.name.help"><a-input v-model="form.name" :placeholder="$t('pages.nodes.namePlaceholder')"/></a-form-item>
            <a-form-item :label='{{ i18n "pages.multiSubscriptions.subId"}}' :validate-status="v.subId.status" :help="v.subId.help"><a-input v-model="form.subId" :placeholder="$t('pages.multiSubscriptions.subIdPlaceholder')"/></a-form-item>
            <a-form-item :label='{{ i18n "pages.multiSubscriptions.nodeIdsLabel"}}' :validate-status="v.nodeIds.status" :help="v.nodeIds.help"><a-input v-model="form.nodeIds" :placeholder="$t('pages.multiSubscriptions.nodeIdsPlaceholder')"/></a-form-item>
            <a-form-item :label='{{ i18n "pages.multiSubscriptions.remark"}}'><a-textarea v-model="form.remark" :placeholder="$t('pages.multiSubscriptions.remarkPlaceholder')" :auto-size="{minRows:2,maxRows:4}"/></a-form-item>
            <a-form-item :label='{{ i18n "pages.multiSubscriptions.enabled"}}'><a-switch v-model="form.enable"/></a-form-item>
            <a-form-item :wrapper-col="{span:16, offset:6}">
              <a-space>
                <a-button type="primary" @click="save">{{ i18n "update"}}</a-button>
                <a-button @click="modals.edit.visible=false">{{ i18n "cancel"}}</a-button>
              </a-space>
            </a-form-item>
          </a-form>
        </a-modal>
      </a-spin>
    </a-layout-content>
  </a-layout>
</a-layout>

<script>
  new Vue({
    delimiters: ['[[', ']]'],
    el: '#app',
    mixins: [MediaQueryMixin],
    data: {
      themeSwitcher,
      loadingStates: { spinning: false, },
      loadingTip: '{{ i18n "loading"}}',
      items: [],
      modals: { edit: { visible: false } },
      form: { id:null, name:'', subId:'', nodeIds:'[]', remark:'', enable:true },
      v: { name:{}, subId:{}, nodeIds:{} },
    },
    methods: {
      async refresh() {
        try {
          const msg = await HttpUtil.get('/panel/api/multi-subscriptions/');
          if (msg.success) {
            this.items = msg.obj || [];
          } else {
            this.$message.error(this.$t('validation.loadFailed'));
          }
        } catch (e) {
          this.$message.error(this.$t('validation.loadFailed'));
        }
      },
      openAdd(){ this.form = { id:null, name:'', subId:'', nodeIds:'[]', remark:'', enable:true }; this.clearValidation(); this.modals.edit.visible=true; },
      openEdit(r){ this.form = Object.assign({}, r); if(typeof this.form.nodeIds !== 'string'){ this.form.nodeIds = JSON.stringify(this.form.nodeIds||[]) } this.clearValidation(); this.modals.edit.visible=true; },
      clearValidation(){ this.v = { name:{}, subId:{}, nodeIds:{} }; },
      validate(){
        let ok = true; this.clearValidation();
        if(!this.form.name){ this.v.name={status:'error', help:this.$t('validation.required')}; ok=false }
        if(this.form.subId && (this.form.subId.length<3 || this.form.subId.length>64)){ this.v.subId={status:'error', help:this.$t('validation.invalidSubId')}; ok=false }
        try{
          const arr = JSON.parse(this.form.nodeIds||'[]');
          if(!Array.isArray(arr) || !arr.every(x=> Number.isInteger(x))){ this.v.nodeIds={status:'error', help:this.$t('validation.invalidNodeIds')}; ok=false }
        }catch(e){ this.v.nodeIds={status:'error', help:this.$t('validation.invalidNodeIds')}; ok=false }
        return ok;
      },
      async save(){
        if(!this.validate()) return;
        let res;
        const payload = Object.assign({}, this.form);
        try{ payload.nodeIds = JSON.parse(this.form.nodeIds||'[]'); }catch(_){ /* keep as string if parsing fails */ }
        if(this.form.id){ res = await HttpUtil.post('/panel/api/multi-subscriptions/'+this.form.id, payload); }
        else{ res = await HttpUtil.post('/panel/api/multi-subscriptions/', payload); }
        if(res && res.success){ this.$message.success(this.$t('validation.saveSuccess')); this.modals.edit.visible=false; this.refresh(); }
        else { this.$message.error(this.$t('validation.saveFailed')); }
      },
      async del(r){ const res = await HttpUtil.post('/panel/api/multi-subscriptions/'+r.id+'/delete'); if(res.success){ this.$message.success(this.$t('validation.saveSuccess')); } else { this.$message.error(this.$t('validation.saveFailed')); } this.refresh(); },
      async copySubUrl(r){
        try {
          const res = await HttpUtil.get('/panel/api/multi-subscriptions/'+r.id+'/subscription-url');
          if(res && res.success && res.obj && res.obj.url){
            await navigator.clipboard.writeText(res.obj.url);
            this.$message.success(this.$t('copy') + ' ' + this.$t('success'));
          } else {
            this.$message.error(this.$t('validation.loadFailed'));
          }
        } catch(e) {
          this.$message.error(this.$t('validation.loadFailed'));
        }
      },
      enableTpl(r){
        return this.$createElement('a-tag', { props: { color: r.enable ? 'green' : 'default' } }, [
          this.$createElement('a-icon', { props: { type: r.enable ? 'check-circle' : 'close-circle' }, style: 'margin-right: 4px' }),
          r.enable ? (this.$t('yes') || 'Yes') : (this.$t('no') || 'No')
        ]);
      },
      actionTpl(r){
        return this.$createElement('span', [
          this.$createElement('a-tooltip', { props: { title: this.$t('pages.multiSubscriptions.edit') || 'Edit' } }, [
            this.$createElement('a-button', { 
              props: { type: 'link', size: 'small' },
              on: { click: () => this.openEdit(r) }
            }, [
              this.$createElement('a-icon', { props: { type: 'edit' } }),
              this.$createElement('span', { style: 'margin-left: 4px' }, this.$t('pages.multiSubscriptions.edit') || 'Edit')
            ])
          ]),
          this.$createElement('a-divider', { props: { type: 'vertical' } }),
          this.$createElement('a-tooltip', { props: { title: this.$t('copy') || 'Copy subscription URL' } }, [
            this.$createElement('a-button', { 
              props: { type: 'link', size: 'small' },
              on: { click: () => this.copySubUrl(r) }
            }, [
              this.$createElement('a-icon', { props: { type: 'copy' } }),
              this.$createElement('span', { style: 'margin-left: 4px' }, this.$t('copy') || 'Copy')
            ])
          ]),
          this.$createElement('a-divider', { props: { type: 'vertical' } }),
          this.$createElement('a-popconfirm', {
            props: {
              title: this.$t('deleteConfirm') || 'Are you sure?',
              okText: this.$t('yes') || 'Yes',
              cancelText: this.$t('no') || 'No'
            },
            on: { confirm: () => this.del(r) }
          }, [
            this.$createElement('a-button', { 
              props: { type: 'link', size: 'small', danger: true }
            }, [
              this.$createElement('a-icon', { props: { type: 'delete' } }),
              this.$createElement('span', { style: 'margin-left: 4px' }, this.$t('pages.multiSubscriptions.delete') || 'Delete')
            ])
          ])
        ]);
      }
    },
    mounted(){ this.refresh(); }
  })
</script>
{{template "page/body_scripts" .}}
{{template "component/aSidebar" .}}
{{template "component/aThemeSwitch" .}}

{{ template "page/body_end" .}}
