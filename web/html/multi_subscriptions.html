{{ template "page/head_start" .}}
{{ template "page/head_end" .}}

{{ template "page/body_start" .}}
<a-layout id="app" v-cloak :class="themeSwitcher.currentTheme + ' multi-subscriptions-page'">
  <a-sidebar></a-sidebar>
  <a-layout id="content-layout">
    <a-layout-content>
      <a-spin :spinning="loadingStates.spinning" :delay="200" :tip="loadingTip">
        <a-row :gutter="[16,16]">
          <a-col :span="24">
            <a-page-header :title='{{ i18n "pages.multiSubscriptions.title"}}'>
              <template slot="extra">
                <a-button type="primary" icon="plus" @click="openAdd">{{ i18n "pages.multiSubscriptions.add"}}</a-button>
                <a-button icon="sync" @click="refresh">{{ i18n "pages.nodes.refresh"}}</a-button>
              </template>
            </a-page-header>
          </a-col>
          <a-col :span="24">
            <a-table :data-source="items" :row-key="'id'" :pagination="false">
              <a-table-column :title='{{ i18n "pages.multiSubscriptions.name"}}' data-index="name" key="name"/>
              <a-table-column :title='{{ i18n "pages.multiSubscriptions.subId"}}' data-index="subId" key="subId"/>
              <a-table-column :title='{{ i18n "pages.multiSubscriptions.nodes"}}' key="nodes" :customRender="(_, r)=> (r.nodeIds)"></a-table-column>
              <a-table-column :title='{{ i18n "pages.multiSubscriptions.remark"}}' data-index="remark" key="remark"/>
              <a-table-column :title='{{ i18n "pages.multiSubscriptions.enabled"}}' key="enable" :customRender="(_, r)=> enableTpl(r)"/>
              <a-table-column :title='{{ i18n "pages.nodes.actions"}}' key="action" :customRender="(_, r)=> actionTpl(r)"/>
            </a-table>
          </a-col>
        </a-row>

        <a-modal :visible="modals.edit.visible" :title='{{ i18n "pages.multiSubscriptions.title"}}' :footer="null" @cancel="modals.edit.visible=false">
          <a-form :label-col="{span:6}" :wrapper-col="{span:16}">
            <a-form-item :label='{{ i18n "pages.multiSubscriptions.name"}}' :validate-status="v.name.status" :help="v.name.help"><a-input v-model="form.name" :placeholder="$t('pages.nodes.namePlaceholder')"/></a-form-item>
            <a-form-item :label='{{ i18n "pages.multiSubscriptions.subId"}}' :validate-status="v.subId.status" :help="v.subId.help"><a-input v-model="form.subId" :placeholder="$t('pages.multiSubscriptions.subIdPlaceholder')"/></a-form-item>
            <a-form-item :label='{{ i18n "pages.multiSubscriptions.nodeIdsLabel"}}' :validate-status="v.nodeIds.status" :help="v.nodeIds.help"><a-input v-model="form.nodeIds" :placeholder="$t('pages.multiSubscriptions.nodeIdsPlaceholder')"/></a-form-item>
            <a-form-item :label='{{ i18n "pages.multiSubscriptions.remark"}}'><a-textarea v-model="form.remark" :placeholder="$t('pages.multiSubscriptions.remarkPlaceholder')" :auto-size="{minRows:2,maxRows:4}"/></a-form-item>
            <a-form-item :label='{{ i18n "pages.multiSubscriptions.enabled"}}'><a-switch v-model="form.enable"/></a-form-item>
            <a-form-item :wrapper-col="{span:16, offset:6}">
              <a-space>
                <a-button type="primary" @click="save">{{ i18n "update"}}</a-button>
                <a-button @click="modals.edit.visible=false">{{ i18n "cancel"}}</a-button>
              </a-space>
            </a-form-item>
          </a-form>
        </a-modal>
      </a-spin>
    </a-layout-content>
  </a-layout>
</a-layout>
{{template "page/body_scripts" .}}
{{template "component/aSidebar" .}}
{{template "component/aThemeSwitch" .}}
<script>
try {
  const { createApp, ref, reactive, onMounted, getCurrentInstance, h } = Vue;

  if (!themeSwitcher) throw new Error('themeSwitcher is not defined');

  const appEl = document.getElementById('app');
  if (!appEl) throw new Error('Element #app not found!');

  const vueApp = createApp({
    delimiters: ['[[', ']]'],
    setup() {
      const internalInstance = getCurrentInstance();
      const $t = (...args) => internalInstance.appContext.config.globalProperties.$t(...args);
      const $message = internalInstance.appContext.config.globalProperties.$message;

      // --- reactive state ---
      const items = ref([]);
      const loadingStates = reactive({ spinning: false });
      const loadingTip = '{{ i18n "loading"}}';
      const modals = reactive({ edit: { visible: false } });
      const form = reactive({ id: null, name: '', subId: '', nodeIds: '[]', remark: '', enable: true });
      const v = reactive({ name: {}, subId: {}, nodeIds: {} });

      // --- methods ---
      const clearValidation = () => { v.name = {}; v.subId = {}; v.nodeIds = {}; };

      const validate = () => {
        let ok = true;
        clearValidation();
        if (!form.name) { v.name = { status: 'error', help: $t('validation.required') }; ok = false; }
        if (form.subId && (form.subId.length < 3 || form.subId.length > 64)) { v.subId = { status: 'error', help: $t('validation.invalidSubId') }; ok = false; }
        try {
          const arr = JSON.parse(form.nodeIds || '[]');
          if (!Array.isArray(arr) || !arr.every(x => Number.isInteger(x))) { v.nodeIds = { status: 'error', help: $t('validation.invalidNodeIds') }; ok = false; }
        } catch { v.nodeIds = { status: 'error', help: $t('validation.invalidNodeIds') }; ok = false; }
        return ok;
      };

      const refresh = async () => {
        try {
          const msg = await HttpUtil.get('/panel/api/multi-subscriptions/');
          items.value = msg.success ? (msg.obj || []) : [];
          if (!msg.success) $message.error($t('validation.loadFailed'));
        } catch {
          $message.error($t('validation.loadFailed'));
        }
      };

      const openAdd = () => { Object.assign(form, { id: null, name: '', subId: '', nodeIds: '[]', remark: '', enable: true }); clearValidation(); modals.edit.visible = true; };
      const openEdit = r => { Object.assign(form, { ...r, nodeIds: typeof r.nodeIds === 'string' ? r.nodeIds : JSON.stringify(r.nodeIds || []) }); clearValidation(); modals.edit.visible = true; };

      const save = async () => {
        if (!validate()) return;
        const payload = { ...form };
        try { payload.nodeIds = JSON.parse(form.nodeIds || '[]'); } catch {}
        const res = form.id
          ? await HttpUtil.post('/panel/api/multi-subscriptions/' + form.id, payload)
          : await HttpUtil.post('/panel/api/multi-subscriptions/', payload);
        if (res && res.success) { $message.success($t('validation.saveSuccess')); modals.edit.visible = false; refresh(); }
        else { $message.error($t('validation.saveFailed')); }
      };

      const del = async r => {
        const res = await HttpUtil.post('/panel/api/multi-subscriptions/' + r.id + '/delete');
        $message[res.success ? 'success' : 'error'](res.success ? $t('validation.saveSuccess') : $t('validation.saveFailed'));
        refresh();
      };

      const copySubUrl = async r => {
        try {
          const res = await HttpUtil.get('/panel/api/multi-subscriptions/' + r.id + '/subscription-url');
          if (res?.success && res.obj?.url) { await navigator.clipboard.writeText(res.obj.url); $message.success($t('copy') + ' ' + $t('success')); }
          else $message.error($t('validation.loadFailed'));
        } catch { $message.error($t('validation.loadFailed')); }
      };

      const enableTpl = r => h('a-tag', { color: r.enable ? 'green' : 'default' }, [
        h('a-icon', { type: r.enable ? 'check-circle' : 'close-circle', style: 'margin-right:4px' }),
        r.enable ? $t('yes') : 'No'
      ]);

      const actionTpl = r => h('span', [
        h('a-tooltip', { title: $t('pages.multiSubscriptions.edit') }, [
          h('a-button', { type: 'link', size: 'small', onClick: () => openEdit(r) }, [
            h('a-icon', { type: 'edit' }),
            h('span', { style: 'margin-left:4px' }, $t('pages.multiSubscriptions.edit'))
          ])
        ]),
        h('a-divider', { type: 'vertical' }),
        h('a-tooltip', { title: $t('copy') }, [
          h('a-button', { type: 'link', size: 'small', onClick: () => copySubUrl(r) }, [
            h('a-icon', { type: 'copy' }),
            h('span', { style: 'margin-left:4px' }, $t('copy'))
          ])
        ]),
        h('a-divider', { type: 'vertical' }),
        h('a-popconfirm', { title: $t('deleteConfirm'), okText: $t('yes'), cancelText: $t('no'), onConfirm: () => del(r) }, [
          h('a-button', { type: 'link', size: 'small', danger: true }, [
            h('a-icon', { type: 'delete' }),
            h('span', { style: 'margin-left:4px' }, $t('pages.multiSubscriptions.delete'))
          ])
        ])
      ]);

      // --- lifecycle ---
      onMounted(() => {
        const appEl = document.getElementById('app');
        if (appEl) { appEl.removeAttribute('v-cloak'); appEl.style.display = ''; }
        refresh();
      });

      return { items, loadingStates, loadingTip, modals, form, v,
               openAdd, openEdit, save, del, copySubUrl, refresh, enableTpl, actionTpl };
    }
  });

  vueApp.mount('#app');

} catch (e) {
  console.error('Vue 3 Composition API initialization error:', e);
  const app = document.getElementById('app');
  if(app){ app.removeAttribute('v-cloak'); app.style.display='block'; }
}
</script>




{{ template "page/body_end" .}}
