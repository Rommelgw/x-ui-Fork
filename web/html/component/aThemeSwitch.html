{{define "component/themeSwitchTemplate"}}
<template>
  <a-menu :theme="themeSwitcher.currentTheme" mode="inline" selected-keys="">
    <a-sub-menu>
      <span slot="title">
        <a-icon type="bulb" :theme="themeSwitcher.isDarkTheme ? 'filled' : 'outlined'"></a-icon>
        <span>{{ i18n "menu.theme" }}</span>
      </span>
      <a-menu-item id="change-theme" class="ant-menu-theme-switch" @mousedown="themeSwitcher.animationsOff()">
        <span>{{ i18n "menu.dark" }}</span>
        <a-switch :style="{ marginLeft: '2px' }" size="small" :default-checked="themeSwitcher.isDarkTheme"
          @change="themeSwitcher.toggleTheme()"></a-switch>
      </a-menu-item>
      <a-menu-item id="change-theme-ultra" v-if="themeSwitcher.isDarkTheme" class="ant-menu-theme-switch"
        @mousedown="themeSwitcher.animationsOffUltra()">
        <span>{{ i18n "menu.ultraDark" }}</span>
        <a-checkbox :style="{ marginLeft: '2px' }" :checked="themeSwitcher.isUltra"
          @click="themeSwitcher.toggleUltra()"></a-checkbox>
      </a-menu-item>
    </a-sub-menu>
  </a-menu>
</template>
{{end}}

{{define "component/themeSwitchTemplateLogin"}}
<template>
  <a-space @mousedown="themeSwitcher.animationsOff()" id="change-theme" direction="vertical" :size="10" :style="{ width: '100%' }">
    <a-space direction="horizontal" size="small">
      <a-switch size="small" :default-checked="themeSwitcher.isDarkTheme" @change="themeSwitcher.toggleTheme()"></a-switch>
      <span>{{ i18n "menu.dark" }}</span>
    </a-space>
    <a-space v-if="themeSwitcher.isDarkTheme" direction="horizontal" size="small">
      <a-checkbox :checked="themeSwitcher.isUltra" @click="themeSwitcher.toggleUltra()"></a-checkbox>
      <span>{{ i18n "menu.ultraDark" }}</span>
    </a-space>
  </a-space>
</template>
{{end}}

{{define "component/aThemeSwitch"}}
<!-- Theme switch templates -->
<script type="text/x-template" id="theme-switch-template">
{{template "component/themeSwitchTemplate" .}}
</script>
<script type="text/x-template" id="theme-switch-login-template">
{{template "component/themeSwitchTemplateLogin" .}}
</script>
<script>
  function createThemeSwitcher() {
    const isDarkTheme = localStorage.getItem('dark-mode') === 'true';
    const isUltra = localStorage.getItem('isUltraDarkThemeEnabled') === 'true';
    if (isUltra) {
      document.documentElement.setAttribute('data-theme', 'ultra-dark');
    }
    const theme = isDarkTheme ? 'dark' : 'light';
    const body = document.querySelector('body');
    if (body) {
      body.setAttribute('class', theme);
    }
    return {
      animationsOff() {
        document.documentElement.setAttribute('data-theme-animations', 'off');
        const themeAnimations = document.querySelector('#change-theme');
        if (themeAnimations) {
          themeAnimations.addEventListener('mouseleave', () => {
            document.documentElement.removeAttribute('data-theme-animations');
          });
          themeAnimations.addEventListener('touchend', () => {
            document.documentElement.removeAttribute('data-theme-animations');
          });
        }
      },
      animationsOffUltra() {
        document.documentElement.setAttribute('data-theme-animations', 'off');
        const themeAnimationsUltra = document.querySelector('#change-theme-ultra');
        if (themeAnimationsUltra) {
          themeAnimationsUltra.addEventListener('mouseleave', () => {
            document.documentElement.removeAttribute('data-theme-animations');
          });
          themeAnimationsUltra.addEventListener('touchend', () => {
            document.documentElement.removeAttribute('data-theme-animations');
          });
        }
      },
      isDarkTheme,
      isUltra,
      get currentTheme() {
        return this.isDarkTheme ? 'dark' : 'light';
      },
      toggleTheme() {
        this.isDarkTheme = !this.isDarkTheme;
        localStorage.setItem('dark-mode', this.isDarkTheme);
        const body = document.querySelector('body');
        if (body) {
          body.setAttribute('class', this.isDarkTheme ? 'dark' : 'light');
        }
        const messageEl = document.getElementById('message');
        if (messageEl) {
          messageEl.className = themeSwitcher.currentTheme;
        }
      },
      toggleUltra() {
        this.isUltra = !this.isUltra;
        if (this.isUltra) {
          document.documentElement.setAttribute('data-theme', 'ultra-dark');
        } else {
          document.documentElement.removeAttribute('data-theme');
        }
        localStorage.setItem('isUltraDarkThemeEnabled', this.isUltra.toString());
      }
    };
  }
  const themeSwitcher = createThemeSwitcher();
  
  // Ensure Vue is available before registering components
  if (typeof Vue !== 'undefined') {
    try {
      // Get template content from script tags
      const themeSwitchTemplateEl = document.getElementById('theme-switch-template');
      const themeSwitchLoginTemplateEl = document.getElementById('theme-switch-login-template');
      
      if (!themeSwitchTemplateEl) {
        console.error('Theme switch template element not found');
      }
      if (!themeSwitchLoginTemplateEl) {
        console.error('Theme switch login template element not found');
      }
      if (themeSwitchTemplateEl) {
        console.log('Theme switch template found, content length:', themeSwitchTemplateEl.innerHTML.length);
      }
      
      // Extract content from <template> tag if present
      function extractTemplateContent(html) {
        if (!html) {
          console.warn('extractTemplateContent: empty HTML');
          return '';
        }
        // Remove <template> tags and get inner content
        const match = html.match(/<template[^>]*>([\s\S]*)<\/template>/);
        if (match) {
          const content = match[1].trim();
          console.log('extractTemplateContent: extracted template content, length:', content.length);
          return content;
        } else {
          console.warn('extractTemplateContent: no <template> tag found, using raw HTML');
          return html.trim();
        }
      }
      
      const themeSwitchTemplate = extractTemplateContent(themeSwitchTemplateEl ? themeSwitchTemplateEl.innerHTML : '');
      const themeSwitchLoginTemplate = extractTemplateContent(themeSwitchLoginTemplateEl ? themeSwitchLoginTemplateEl.innerHTML : '');
      
      console.log('Registering Vue component a-theme-switch with template length:', themeSwitchTemplate.length);
      Vue.component('a-theme-switch', {
        template: themeSwitchTemplate,
        data: () => ({
          themeSwitcher
        }),
        mounted() {
          const messageEl = document.getElementById('message');
          if (messageEl && this.$message) {
            this.$message.config({
              getContainer: () => messageEl
            });
            messageEl.className = themeSwitcher.currentTheme;
          }
        }
      });
      console.log('Registering Vue component a-theme-switch-login with template length:', themeSwitchLoginTemplate.length);
      Vue.component('a-theme-switch-login', {
        template: themeSwitchLoginTemplate,
        data: () => ({
          themeSwitcher
        }),
        mounted() {
          const messageEl = document.getElementById('message');
          if (messageEl && this.$message) {
            this.$message.config({
              getContainer: () => messageEl
            });
            messageEl.className = themeSwitcher.currentTheme;
          }
        }
      });
      console.log('Vue components a-theme-switch and a-theme-switch-login registered successfully');
    } catch (e) {
      console.error('Error registering Vue components:', e);
      console.error('Error stack:', e.stack);
    }
  } else {
    console.error('Vue is not available when trying to register theme switch components');
  }
</script>
{{end}}